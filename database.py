import os
import aiosqlite
import asyncpg
import logging
from datetime import datetime

# 0AB@>9:8
DB_NAME = "bot_database.db"
DATABASE_URL = os.getenv("DATABASE_URL") # Railway ?@54>AB02;O5B MBC ?5@5<5==CN 4;O Postgres

logger = logging.getLogger(__name__)

class Database:
    def __init__(self):
        self.type = "postgres" if DATABASE_URL else "sqlite"
        self.pool = None

    async def connect(self):
        if self.type == "postgres":
            try:
                self.pool = await asyncpg.create_pool(DATABASE_URL)
                logger.info("Connected to PostgreSQL")
                await self.init_postgres()
            except Exception as e:
                logger.error(f"Postgres connection failed: {e}. Falling back to SQLite.")
                self.type = "sqlite"
        
        if self.type == "sqlite":
            logger.info("Using SQLite")
            await self.init_sqlite()

    async def init_postgres(self):
        async with self.pool.acquire() as conn:
            await conn.execute("""
                CREATE TABLE IF NOT EXISTS users (
                    user_id BIGINT PRIMARY KEY,
                    username TEXT,
                    selected_model TEXT DEFAULT 'gemini-2.5-flash',
                    system_instruction TEXT DEFAULT '"K 0ý>;57=K9 8 C<=K9 0AA8AB5=B.',
                    temperature REAL DEFAULT 0.7,
                    max_tokens INTEGER DEEAULT4Mýý\ýWýýýýýýýPSýQýUSýSýKýýýX[W\ýÜýHýýýPSýQýUSýQBý
BýýýýBý]ýZ]ýÛýý^Xý]JýýýýPUHPýHQýýýVTýýY\ýýYýWý\ýH
ýYýTýPSýSPTýHýVKý\ý\ýýYýQýSýýQýTýSýýTý\ý\ýý=\ý\ýýY
KýýýHVýýÝ[ýVý\ýýYYXHýýýPSýQýUSýSýKý[Y\ý[\SQTýSTQýUSýTýýSýýSQTýSTý
BýýýýBýý\ý[ýýYý[ý]ýý[]Jý[ýNýý\ý[ýýý]Z[ýý[]KýýÛýXý
ýÐSQJH\ýýýý]ýZ]ýý^Xý]JýýýýPUHPýHQýýýVTýý\ý\ýý
ý\ý\ýýYSýQýTýýSPTýHýVKý\ý\ýý[YHVýý[XýYý[ý[VQýUS	ýý[Z[ýKLýýKYý\ý	ýýý\ý[Wý[ýýýXý[ÈVQýUS	ý(ýbý4/ý/ý.ý-t-ý/tbý.H4.4`ý/4/tbý.H4,4`t`t.4`t`ý-t/t`ýýýý[\\ý]\ýHýPSQýUSýýýX^ýýý[ýýSýQýTýQýUS
Mýý\ýWýýýýýýýPSýQýUSýýýX[W\ýÜýHýýýPSýQýUSBý
BýýýýBýýZY][Üýýý[]BýýNýý]ýZ]ýý^Xý]JýSTýPýH\ý\ýýQýýSSýýýX[W\ýÜýHýýýPSýQýUSHýBý^ý\ý\ý‚ý]ýZ]ýý^Xý]JýýýýPUHPýHQýýýVTýýY\ýýYýWý\ýH
ýYSýQýTýýSPTýHýVHUUýSýSQSýý\ý\ýýYSýQýTýýýýHVýýÝ[ýVý\ýýYYXHýýýPSýQýUSý[Y\ý[\UUSQHQýUSýTýýSýýSQTýSTýýRQÈýVH
\ý\ýýY
HýQýTýSýýTý\ý\ýý
\ý\ýýY
Bý
BýýýýBý]ýZ]ýýýý[Z]

Býý\ý[ýýYýý]ý\ý\ýýý][ýýýý[ý\ý\ýýYý[ý
NýýYý][ýHˆý\ý\ýýYýý\ý\ýýYýýý[XýYý[ý[ýýýý[Z[ýKLýýKYý\ýýýýý\ý[Wý[ýýýXý[Èýýý(ýbý4/ý/ý.ý-t-ý/tbý.H4.4`ý/4/tbý.H4,4`t`t.4`t`ý-t/t`ýýýýý[\\ý]\ýHýýýýýýX^ýýý[ýý
Mýýý\ýWýýýýý[ýKýýýýX[W\ýÜýHýýýYBýBýýYýý[ýý\HOHýýý\ýýYýýýý[ýýýýý]ýZ]ý[ýýýÛýXý

Bý\ý[ýýý]ý[ýýýýýXý]Z\ýJ
H\ýýÛýýýýýýH]ýZ]ýÛýýý]ýýýýýýSPý
ýýýýH\ý\ýýýTýH\ý\ýýYH	Hý\ý\ýýY
BýYýýýˆý]\ýýXý
ýýýBý]ýZ]ýÛýý^Xý]JýSýýTýSýý\ý\ýý
\ý\ýýY
HýSQTý
	JHÈýÑýPýýýýSý\ý\ýýY
Býý]\ýýYý][ˆ[ýNýý\ý[ýýý]Z[ýý[]KýýÛýXý
ýÐSQJH\ýýýýýýýýýXXýHHZ[ýý[]Kýýýˆ\ý[ýýý]ýý^Xý]JýýSPý
ýýýýH\ý\ýýýTýH\ý\ýýYH
\ý\ýýY
JH\ýý\ýýýýýýýH]ýZ]ý\ýýýý]ýÙJ
BýYýýýˆý]\ýýXý
ýýýBý]ýZ]ýý^Xý]JýSýýTýSýý\ý\ýý
\ý\ýýY
HýSQTý
ýHý
\ý\ýýY
JBý]ýZ]ýýýý[Z]

Býý]\ýýYý][‚ý\ý[ýýYý\]Wý\ý\ýýý][ýýý[ý\ý\ýýYý[ýý][ýˆýýý[YJNýýýý][\ý[ýýYý][ýýýýý]ý[ýýS[ýýXý[Âý[ýýYýý][ýýýHˆ	ý\ý\ýý[YIý	ýý[XýYý[ý[	ý	ýý\ý[Wý[ýýýXý[Éýý	ý[\\ý]\ýIý	ýX^ýýý[ýýý	ý\ýWýýýýý	ýýýX[W\ýÜýIˆBýýYýý][ýýýý[ý[ýýYýý][ýý‚ýýZ\ýHý[YQ\ýý
ýý[ýý[Yý][ýˆýý][ýýHýBýýYýý[ýý\HOHýýý\ýýYýýýý[ýýýýý]ýZ]ý[ýýýÛýXý

Bý\ý[ýýý]ý[ýýýýýXý]Z\ýJ
H\ýýÛýýýýýý\ýýýýX[ý[ý[ýˆYýý][ýý[ýýý\ýWýýýýý	ýýýX[W\ýÜýIýNýýý[YHHýýý
ý[YJBýýýYýNýý][ýý\ýý[Y]YýýýHý][\ýý]Y\ýHHýýTUH\ý\ýýýUýýý][ýýHH	HýTýH\ý\ýýYH	ýýý]ýZ]ýÛýý^Xý]J]Y\ýKý[YK\ý\ýýY
Bý[ýNýý\ý[ýýý]Z[ýý[]KýýÛýXý
ýÐSQJH\ýýýýýýYýNýý][ýý\ýý[Y]YýýýHý][\ýý]Y\ýHHýýTUH\ý\ýýýUýý][ýýHHýýTýH\ý\ýýYHý]ýZ]ýý^Xý]J]Y\ýK
ý[YK\ý\ýýY
JBý]ýZ]ýýýý[Z]

Býý\ý[ýýYýý]ýWýY\ýýYýJý[ý\ý\ýýYý[ýýýNýýýýÝ[ýýýý\ýýYYXNýýýýHý[ýJNýýYýý[ýý\HOHýýý\ýýYýýýý[ýýýýý]ýZ]ý[ýýýÛýXý

Bý\ý[ýýý]ý[ýýýýýXý]Z\ýJ
H\ýýÛýýý]ýZ]ýÛýý^Xý]JýýSýýTýSýýY\ýýYýWý\ýH
\ý\ýýYýýKýÝ[ý\ýýYYXJHýSQTý
	K	ý	ý	
Hýý\ý\ýýYýýKýÝ[ý\ýýYYXBý
Bý[ýNýý\ý[ýýý]Z[ýý[]KýýÛýXý
ýÐSQJH\ýýýý]ýZ]ýý^Xý]JýýSýýTýSýýY\ýýYýWý\ýH
\ý\ýýYýýKýÝ[ý\ýýYYXJHýSQTý
ýýýýHýý
\ý\ýýYýýKýÝ[ý\ýýYYXJBý
Bý]ýZ]ýýýý[Z]

Býý\ý[ýýYýý]ýý]ý\ýJý[ý\ý\ýýYý[ý[Z]ý[ýHý
NýýYýý[ýý\HOHýýý\ýýYýýýý[ýýýýý]ýZ]ý[ýýýÛýXý

Bý\ý[ýýý]ý[ýýýýýXý]Z\ýJ
H\ýýÛýýýýýýýH]ýZ]ýÛýýý]ýýýýSPýýýKýÝ[ýýýýHY\ýýYýWý\ýHýTýH\ý\ýýYH	HTýýHYTýýSRU	ýýý\ý\ýýY[Z]ý
Býý]\ýýýXý
ýýýHýýýý[ýý]ý\ýýY
ýýýýWBý[ýNýý\ý[ýýý]Z[ýý[]KýýÛýXý
ýÐSQJH\ýýýýýýýýýXXýHHZ[ýý[]Kýýýˆ\ý[ýýý]ýý^Xý]JýýýSPýýýKýÝ[ýýýýHY\ýýYýWý\ýHýTýH\ý\ýýYHýTýýHYTýýSRUý
\ý\ýýY[Z]
Bý
H\ýý\ýýýýýýýýH]ýZ]ý\ýýýý]ý[

Býý]\ýýýXý
ýýýHýýýý[ýý]ý\ýýY
ýýýýWBýý\ý[ýýYýýX\ýý\ýJý[ý\ý\ýýYý[ý
NýýYýý[ýý\HOHýýý\ýýYýýýý[ýýýýý]ýZ]ý[ýýýÛýXý

Bý\ý[ýýý]ý[ýýýýýXý]Z\ýJ
H\ýýÛýýý]ýZ]ýÛýý^Xý]JýSUHýýýHY\ýýYýWý\ýHýTýH\ý\ýýYH	Hý\ý\ýýY
Bý[ýNýý\ý[ýýý]Z[ýý[]KýýÛýXý
ýÐSQJH\ýýýý]ýZ]ýý^Xý]JýSUHýýýHY\ýýYýWý\ýHýTýH\ý\ýýYH
\ý\ýýY
JBý]ýZ]ýýýý[Z]

Býýýý[ýý]È[ýý[ýýBýýý[ýý[ýýHH]Xý\ýJ
Býýý\\ýý[ýý[Üýýýý\]Xý[]Bý\ý[ýýYý[ý]ýý
Nýý]ýZ]ýý[ýý[ýýKýýÛýXý

Býý\ý[ýýYýý]ý\ý\ýýý][ýýý\ý\ýýY
Nýýý]\ýý]ýZ]ýý[ýý[ýýKýý]ý\ý\ýýý][ýýý\ý\ýýY
Býý\ý[ýýYý\]Wý\ý\ýýý][ýý\ý\ýýYý][ýýý[YJNýý]ýZ]ýý[ýý[ýýKý\]Wý\ý\ýýý][ýý\ý\ýýYý][ýýý[YJBýý\ý[ýýYýý]ýWýY\ýýYýJ\ý\ýýYýýKýÝ[ý\ýýYYXOQý[ýJNýý]ýZ]ýý[ýý[ýýKýý]ýWýY\ýýYýJ\ý\ýýYýýKýÝ[ý\ýýYYXJBýý\ý[ýýYýý]ýý]ý\ýJ\ý\ýýY[Z]Lý
Nýýý]\ýý]ýZ]ýý[ýý[ýýKýý]ýý]ý\ýJ\ý\ýýY[Z]
Býý\ý[ýýYýýX\ýý\ýJ\ý\ýýY
Nýý]ýZ]ýý[ýý[ýýKýýX\ýý\ýJ\ý\ýýY
