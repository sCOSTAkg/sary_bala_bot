import os
import aiosqlite
import asyncpg
import logging
from datetime import datetime

# Настройки
DB_NAME = "bot_database.db"
DATABASE_URL = os.getenv("DATABASE_URL") # Railway предоставляет эту переменную для Postgres

logger = logging.getLogger(__name__)

class Database:
    def __init__(self):
        self.type = "postgres" if DATABASE_URL else "sqlite"
        self.pool = None

    async def connect(self):
        if self.type == "postgres":
            try:
                self.pool = await asyncpg.create_pool(DATABASE_URL)
                logger.info("Connected to PostgreSQL")
                await self.init_postgres()
            except Exception as e:
                logger.error(f"Postgres connection failed: {e}. Falling back to SQLite.")
                self.type = "sqlite"
        
        if self.type == "sqlite":
            logger.info("Using SQLite")
            await self.init_sqlite()

    async def init_postgres(self):
        async with self.pool.acquire() as conn:
            await conn.execute("""
                CREATE TABLE IF NOT EXISTS susers (
                    user_id BIGINT PRIMARY KEY,
                    username TEXT,
                    selected_model TEXT DEFAULT 'gemini-2.5-flash',
                    system_instruction TEXT DEFAULT 'Ты 0олезный и умный ассистент.',
                    temperature REAL DEFAULT 0.7,
                    max_tokens INTEGER DEEAULT4M\WPSQUSSKX[Wܙ\ۜHPSQUSQB
BB]Z]ۛ^X]JԑPUHPHQVTY\YW\ܞH
YTPSSPTHVK\\YQSQTST\\=\\Y
KHV۝[V\YYXHPSQUSSK[Y\[\SQTSTQUSTSSQTST
BB\[Y[][]J[N\[]Z[[]KۛX
ӐSQJH\]Z]^X]JԑPUHPHQVT\\
\\YSQTSPTHVK\\[YHV[XY[[VQUS	[Z[KLKY\	\[W[X[ۈVQUS	(b4//.-t-/tb.H4.4`/4/tb.H4,4`t`t.4`t`-t/t`[\\]\HPSQUSX^[SQTQUSM\WPSQUSX[Wܙ\ۜHPSQUSB
BBZYܘ][ۜ܈[]BN]Z]^X]JSTPH\\QSSX[Wܙ\ۜHPSQUSHB^\\]Z]^X]JԑPUHPHQVTY\YW\ܞH
YSQTSPTHVHUUSԑSQS\\YSQTHV۝[V\YYXHPSQUS[Y\[\UUSQHQUSTSSQTSTԑRQӈVH
\\Y
HQTST\\
\\Y
B
BB]Z][Z]

B\[Y]\\][[\\Y[
NY][H\\Y\\Y[XY[[[Z[KLKY\\[W[X[ۈ(b4//.-t-/tb.H4.4`/4/tb.H4,4`t`t.4`t`-t/t`[\\]\HX^[ȎM\WȎ[KX[Wܙ\ۜHYBBY[\HOHܙ\ȎY[]Z][ۛX

B\[][X]Z\J
H\ۛH]Z]ۛ]SP
H\\TH\\YH	H\\Y
BYΈ]\X
B]Z]ۛ^X]JSTS\\
\\Y
HSQT
	JHӈӑPSȋ\\Y
B]\Y][[N\[]Z[[]KۛX
ӐSQJH\٘XܞHHZ[[]K\[]^X]JSP
H\\TH\\YHȋ
\\Y
JH\\܎H]Z]\܋]ۙJ
BYΈ]\X
B]Z]^X]JSTS\\
\\Y
HSQT
H
\\Y
JB]Z][Z]

B]\Y][\[Y\]W\\][[\\Y[][Έ[YJN][\[Y][][S[X[ۂ[Y][H	\\[YI	[XY[[		\[W[X[ۉ	[\\]\I	X^[	\W	X[Wܙ\ۜIBY][[[Y][΂Z\H[YQ\܊[[Y][Έ][HBY[\HOHܙ\ȎY[]Z][ۛX

B\[][X]Z\J
H\ۛܙ\X[[[Y][[\W	X[Wܙ\ۜIN[YHH
[YJBYN][\[Y]YH][\]Y\HHTUH\\U][HH	HTH\\YH	]Z]ۛ^X]J]Y\K[YK\\Y
B[N\[]Z[[]KۛX
ӐSQJH\YN][\[Y]YH][\]Y\HHTUH\\U][HHTH\\YHȂ]Z]^X]J]Y\K
[YK\\Y
JB]Z][Z]

B\[Y]WY\YJ[\\Y[N۝[\YYXNH[JNY[\HOHܙ\ȎY[]Z][ۛX

B\[][X]Z\J
H\ۛ]Z]ۛ^X]JSTSY\YW\ܞH
\\YK۝[\YYXJHSQT
	K			
H\\YK۝[\YYXB
B[N\[]Z[[]KۛX
ӐSQJH\]Z]^X]JSTSY\YW\ܞH
\\YK۝[\YYXJHSQT
H
\\YK۝[\YYXJB
B]Z][Z]

B\[Y]]\ܞJ[\\Y[[Z][H
NY[\HOHܙ\ȎY[]Z][ۛX

B\[][X]Z\J
H\ۛH]Z]ۛ]SPK۝[HY\YW\ܞHTH\\YH	HԑTHYTSRU	\\Y[Z]
B]\X
H܈[]\Y
WB[N\[]Z[[]KۛX
ӐSQJH\٘XܞHHZ[[]K\[]^X]JSPK۝[HY\YW\ܞHTH\\YHԑTHYTSRUȋ
\\Y[Z]
B
H\\܎H]Z]\܋][

B]\X
H܈[]\Y
WB\[YX\\ܞJ[\\Y[
NY[\HOHܙ\ȎY[]Z][ۛX

B\[][X]Z\J
H\ۛ]Z]ۛ^X]JSUHHY\YW\ܞHTH\\YH	H\\Y
B[N\[]Z[[]KۛX
ӐSQJH\]Z]^X]JSUHHY\YW\ܞHTH\\YHȋ
\\Y
JB]Z][Z]

B[]ۈ[[B[[HH]X\J
Bܘ\\[[ۜ܈\]X[]B\[Y[]
N]Z][[KۛX

B\[Y]\\][\\Y
N]\]Z][[K]\\][\\Y
B\[Y\]W\\][\\Y][[YJN]Z][[K\]W\\][\\Y][[YJB\[Y]WY\YJ\\YK۝[\YYXOQ[JN]Z][[K]WY\YJ\\YK۝[\YYXJB\[Y]]\ܞJ\\Y[Z]L
N]\]Z][[K]]\ܞJ\\Y[Z]
B\[YX\\ܞJ\\Y
N]Z][[KX\\ܞJ\\Y
